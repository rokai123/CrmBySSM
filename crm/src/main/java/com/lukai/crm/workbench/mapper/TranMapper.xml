<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lukai.crm.workbench.mapper.TranMapper">

    <!-- ==================== ResultMap ==================== -->
    <resultMap id="BaseResultMap" type="com.lukai.crm.workbench.domain.Tran">
        <id     column="id"               property="id" jdbcType="CHAR"/>
        <result column="owner"            property="owner"/>
        <result column="money"            property="money"/>
        <result column="name"             property="name"/>
        <result column="expected_date"    property="expectedDate"/>
        <result column="customer_id"      property="customerId"/>
        <result column="stage"            property="stage"/>
        <result column="type"             property="type"/>
        <result column="source"           property="source"/>
        <result column="activity_id"      property="activityId"/>
        <result column="contacts_id"      property="contactsId"/>
        <result column="create_by"        property="createBy"/>
        <result column="create_time"      property="createTime"/>
        <result column="edit_by"          property="editBy"/>
        <result column="edit_time"        property="editTime"/>
        <result column="description"      property="description"/>
        <result column="contact_summary"  property="contactSummary"/>
        <result column="next_contact_time" property="nextContactTime"/>
    </resultMap>
    <!-- ==================== ResultMap ==================== -->
    <resultMap id="BaseResultMapVO" type="com.lukai.crm.workbench.domain.TranVO">
        <id     column="id"               property="id" jdbcType="CHAR"/>
        <result column="owner"            property="owner"/>
        <result column="money"            property="money"/>
        <result column="name"             property="name"/>
        <result column="expected_date"    property="expectedDate"/>
        <result column="customer_id"      property="customerId"/>
        <result column="stage"            property="stage"/>
        <result column="type"             property="type"/>
        <result column="source"           property="source"/>
        <result column="activity_id"      property="activityId"/>
        <result column="contacts_id"      property="contactsId"/>
        <result column="create_by"        property="createBy"/>
        <result column="create_time"      property="createTime"/>
        <result column="edit_by"          property="editBy"/>
        <result column="edit_time"        property="editTime"/>
        <result column="description"      property="description"/>
        <result column="contact_summary"  property="contactSummary"/>
        <result column="next_contact_time" property="nextContactTime"/>
        <result column="order_no"  property="orderNo"/>
    </resultMap>

    <!-- ==================== Base Column List ==================== -->
    <sql id="Base_Column_List">
        id,
        owner,
        money,
        name,
        expected_date,
        customer_id,
        stage,
        type,
        source,
        activity_id,
        contacts_id,
        create_by,
        create_time,
        edit_by,
        edit_time,
        description,
        contact_summary,
        next_contact_time
    </sql>

    <!-- ==================== 常用 CRUD（可选） ==================== -->

    <!-- 根据ID查询交易 -->
    <select id="selectByPrimaryKey"
            parameterType="string"
            resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tbl_tran
        WHERE id = #{id}
    </select>

    <!-- 新增交易 -->
    <insert id="insertTran"
            parameterType="com.lukai.crm.workbench.domain.Tran">
        INSERT INTO tbl_tran (
            <include refid="Base_Column_List"/>
        ) VALUES (
            #{id},
            #{owner},
            #{money},
            #{name},
            #{expectedDate},
            #{customerId},
            #{stage},
            #{type},
            #{source},
            #{activityId},
            #{contactsId},
            #{createBy},
            #{createTime},
            #{editBy},
            #{editTime},
            #{description},
            #{contactSummary},
            #{nextContactTime}
        )
    </insert>
	<select id="selecTransByConditionForPage" parameterType="map" resultMap="BaseResultMap">
        SELECT
        	t.id,
        	u1.name as owner,
        	t.money,
        	t.name,
        	t.expected_date,
        	c.name as customer_id,
        	d1.value as stage,
        	d2.value as type,
        	d3.value as source,
        	t.activity_id,
        	ct.fullname as contacts_id,
        	u2.name as create_by,
        	t.create_time,
        	t.edit_by,
        	t.edit_time,
        	t.description,
        	t.contact_summary,
        	t.next_contact_time
        FROM tbl_tran t 
        	join tbl_customer c on t.customer_id = c.id
        	join tbl_user u1 on t.owner = u1.id
        	join tbl_user u2 on t.create_by = u2.id
        	left join tbl_dic_value d1 on t.stage = d1.id
        	left join tbl_dic_value d2 on t.type = d2.id
        	left join tbl_dic_value d3 on t.source = d3.id
        	left join tbl_contacts ct on t.contacts_id = ct.id
        <where>
            <if test="name != null and name != ''">
            	<bind name="namePattern" value="'%' + name + '%'" />
                AND t.name like #{namePattern}
            </if>
             <if test="owner != null and owner != ''">
             	<bind name="ownerPattern" value="'%' + owner + '%'" />
                AND u1.name like #{ownerPattern}
            </if>
            <if test="customerName != null and customerName != ''">
            	<bind name="customerNamePattern" value="'%' + customerName + '%'" />
                AND c.name like #{customerNamePattern}
            </if>
            <if test="stage != null and stage != ''">
                AND t.stage = #{stage}
            </if>
            <if test="type != null and type != ''">
                AND t.type = #{type}
            </if>
            <if test="source != null and source != ''">
                AND t.source = #{source}
            </if>
            <if test="contactsName != null and contactsName != ''">
            	<bind name="contactsNamePattern" value="'%' + contactsName + '%'" />
                AND ct.fullname like #{contactsNamePattern}
             </if>
        </where>
        ORDER BY t.create_time DESC
        LIMIT #{beginNo}, #{pageSize}
    </select>
	
	<select id="selectTransByConditionForPageCount" parameterType="map" resultType="int">
        SELECT
        	count(1)
        FROM tbl_tran t 
        	join tbl_customer c on t.customer_id = c.id
        	join tbl_user u1 on t.owner = u1.id
        	join tbl_user u2 on t.create_by = u2.id
        	left join tbl_dic_value d1 on t.stage = d1.id
        	left join tbl_dic_value d2 on t.type = d2.id
        	left join tbl_dic_value d3 on t.source = d3.id
        	left join tbl_contacts ct on t.contacts_id = ct.id
        <where>
            <if test="name != null and name != ''">
            	<bind name="namePattern" value="'%' + name + '%'" />
                AND t.name like #{namePattern}
            </if>
             <if test="owner != null and owner != ''">
             	<bind name="ownerPattern" value="'%' + owner + '%'" />
                AND u1.name like #{ownerPattern}
            </if>
            <if test="customerId != null and customerId != ''">
            	<bind name="customerId" value="'%' + customerId + '%'" />
                AND c.name like #{customerId}
            </if>
            <if test="stage != null and stage != ''">
                AND t.stage = #{stage}
            </if>
            <if test="type != null and type != ''">
                AND t.type = #{type}
            </if>
            <if test="source != null and source != ''">
                AND t.source = #{source}
            </if>
            <if test="contactsId != null and contactsId != ''">
            	<bind name="contactsId" value="'%' + contactsId + '%'" />
                AND ct.name like #{contactsId}
             </if>
        </where>
	</select>
	
	<select id="selectTranForDetailById" parameterType="string" resultMap="BaseResultMapVO">
        SELECT
        	t.id,
        	u1.name as owner,
        	t.money,
        	t.name,
        	t.expected_date,
        	c.name as customer_id,
        	d1.value as stage,
        	d2.value as type,
        	d3.value as source,
        	a.name as activity_id,
        	ct.fullname as contacts_id,
        	u2.name as create_by,
        	t.create_time,
        	u3.name as edit_by,
        	t.edit_time,
        	t.description,
        	t.contact_summary,
        	t.next_contact_time,
        	dv.order_no as order_no
        FROM tbl_tran t 
        	join tbl_customer c on t.customer_id = c.id
        	join tbl_user u1 on t.owner = u1.id
        	join tbl_user u2 on t.create_by = u2.id
        	left join tbl_user u3 on t.edit_by = u3.id
        	left join tbl_dic_value d1 on t.stage = d1.id
        	left join tbl_dic_value d2 on t.type = d2.id
        	left join tbl_dic_value d3 on t.source = d3.id
        	left join tbl_contacts ct on t.contacts_id = ct.id
        	left join tbl_activity a on t.activity_id = a.id
        	left join tbl_dic_value dv on t.stage = dv.id

        WHERE t.id = #{id}
    </select>
    
    <delete id="deleteTranByIds" parameterType="string">
    	delete from tbl_tran where id in
    	<foreach collection="array " item="id" open="(" separator="," close=")">
        		#{id}
        </foreach>
    </delete>
    
    <select id="selectTransByCustomerId" parameterType="string" resultMap="BaseResultMapVO">
    	select
    		t.id,
	        t.money,
	        t.name,
	        dv1.value as stage,
	        dv2.value as type,
	        expected_date
	    from tbl_tran t
	    	join tbl_dic_value dv1 on dv1.id=t.stage
	    	join tbl_dic_value dv2 on dv2.id=t.type
	    where t.customer_id=#{cusId}
    </select>
    </mapper>
